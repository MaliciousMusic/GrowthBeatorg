<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sound Buttons (Web Audio API)</title>
  <style>
    /* (same CSS as before) */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
      background-color: #000;
      overflow-y: scroll;
    }
    .main-flexbox {
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      background-color: #ffffff;
    }
    .row {
      display: flex;
      flex: 1;
    }
    .column {
      display: flex;
      flex-direction: column;
      flex: 1;
      background-color: #ffffff;
      box-sizing: border-box;
    }
    .button {
      flex: 1;
      border: 3px #f0f0f0;
      text-align: center;
      font-size: 1rem;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .button:hover {
      transform: scale(1.05);
    }
    .selected {
      filter: brightness(250%);
    }
    .big-button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      height: 50px;
      width: 100%;
    }
    .big-button {
      background-color: white;
      border: #0066cc;
      color: #000;
      font-family: "Arial";
      font-size: 1.2rem;
      width: 40%;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.3s;
      height: 40px;
    }
    .big-button:hover {
      background-color: #f0f0f0;
      transform: scale(1.05);
    }
    footer {
      height: 10vh;
      background-color: #222;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      text-align: center;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
    }
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex; 
      justify-content: center; 
      align-items: center;
      z-index: 999; 
    }
    .modal-window {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .modal-window input {
      padding: 8px;
      font-size: 1rem;
      margin-top: 10px;
      display: block;
      width: 100%;
    }
    .modal-window button {
      margin-top: 10px;
      padding: 8px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Modal for username -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-window">
      <h2>Enter Username</h2>
      <input type="text" id="usernameInput" placeholder="Username" />
      <button id="usernameSubmit">OK</button>
    </div>
  </div>

  <div class="main-flexbox">

    <div class="row">
      <!-- ... (same button columns as before) ... -->
      <!-- Column 1: "hihat" -->
      <div class="column" data-sound="hihat">
        <button class="button blue2" data-frequency="1000"></button>
        <button class="button blue" data-frequency="2000"></button>
      </div>
      <!-- Column 2: "kick" -->
      <div class="column" data-sound="kick">
        <button class="button green0" data-frequency="20"></button>
        <button class="button green1" data-frequency="40"></button>
        <button class="button green2" data-frequency="60"></button>
        <button class="button green3" data-frequency="80"></button>
        <button class="button green1" data-frequency="120"></button>
        <button class="button green2" data-frequency="140"></button>
        <button class="button green3" data-frequency="160"></button>
        <button class="button green4" data-frequency="180"></button>
        <button class="button green5" data-frequency="200"></button>
        <button class="button green6" data-frequency="220"></button>
        <button class="button green7" data-frequency="240"></button>
        <button class="button green8" data-frequency="280"></button>
        <button class="button green9" data-frequency="100"></button>
      </div>
      <!-- Column 3: "distortion" -->
      <div class="column" data-sound="distortion">
        <button class="button red" data-frequency="100"></button>
        <button class="button orange" data-frequency="200"></button>
        <button class="button yellow" data-frequency="100"></button>
        <button class="button green1" data-frequency="100"></button>
        <button class="button cyan" data-frequency="300"></button>
        <button class="button pink" data-frequency="500"></button>
        <button class="button fuschia" data-frequency="600"></button>
        <button class="button purple" data-frequency="700"></button>
      </div>
      <!-- Column 4: "bass" -->
      <div class="column" data-sound="bass">
        <button class="button red" data-frequency="100"></button>
        <button class="button orange" data-frequency="200"></button>
        <button class="button yellow" data-frequency="100"></button>
        <button class="button green1" data-frequency="100"></button>
        <button class="button cyan" data-frequency="300"></button>
        <button class="button pink" data-frequency="500"></button>
        <button class="button fuschia" data-frequency="600"></button>
        <button class="button purple" data-frequency="700"></button>
      </div>
      <!-- Column 5: "snare" -->
      <div class="column" data-sound="snare">
        <button class="button blue0" data-frequency="123.25"></button>
        <button class="button blue" data-frequency="587.33"></button>
        <button class="button blue2" data-frequency="659.25"></button>
      </div>
      <!-- Column 6: "choir" -->
      <div class="column" data-sound="choir">
        <button class="button ye0" data-frequency="230"></button>
        <button class="button ye1" data-frequency="260"></button>
        <button class="button ye2" data-frequency="290"></button>
        <button class="button ye3" data-frequency="320"></button>
        <button class="button ye1" data-frequency="380"></button>
        <button class="button ye2" data-frequency="410"></button>
        <button class="button ye3" data-frequency="440"></button>
        <button class="button ye4" data-frequency="470"></button>
        <button class="button ye5" data-frequency="500"></button>
        <button class="button ye6" data-frequency="530"></button>
        <button class="button ye7" data-frequency="560"></button>
        <button class="button ye8" data-frequency="590"></button>
        <button class="button ye9" data-frequency="350"></button>
      </div>
    </div>

    <div class="big-button-container">
      <button class="big-button" id="recordButton">R E C O R D</button>
      <button class="big-button" id="deleteLoopButton">DELETE LOOP</button>
    </div>

    <footer class="footer">
      <p>Â© 2025 GrowthBeat. All Rights Reserved.</p>
    </footer>
  </div>

  <script>
    // === Audio Setup
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);

    // Lowpass filter for "selected mode"
    let modulatorFilter = audioCtx.createBiquadFilter();
    modulatorFilter.type = 'lowpass';
    modulatorFilter.frequency.value = 22050;
    let isFilterActive = false;
    let lfoOscillators = [];

    // === Global State
    let isRecording = false;
    let recordedLayers = [];
    let currentLayer = [];
    let playbackTimeouts = [];
    let activeNotes = new Map();
    const activeOscillators = new Map();
    let selectionMode = false;
    let selectedButtons = new Set();
    let holdTimeout = null;
    let canUseSelectionMode = false; // locked until "Agent33"

    // === Sound Generators (same as your code)...

    function play808Sound(f){/* ... */}  
    function playDistortionSpectralSpace(f){/* ... */}  
    function playChoir(f){/* ... */}  
    function playSynth1(f){/* ... */}  
    function playSynth4(f){/* ... */}  
    function playSynth6(f){/* ... */}  

    function playColumnSoundStart(column, frequency) {
      const soundType = column.getAttribute('data-sound');
      switch (soundType) {
        case 'kick': play808Sound(frequency); break;
        case 'distortion': playDistortionSpectralSpace(frequency); break;
        case 'choir': playChoir(frequency); break;
        case 'snare': playSynth1(frequency); break;
        case 'hihat': playSynth4(frequency); break;
        case 'bass': playSynth6(frequency); break;
        default: playChoir(frequency); break;
      }
    }

    function scheduleNotePlayback(column, frequency, offset, duration){/* ... */} 
    function playRecordedLayers(){/* ... same loop code ... */}

    // === Buttons
    const buttons = document.querySelectorAll('.button');
    buttons.forEach(button => {
      const column = button.closest('.column');

      function handleButtonSelection() {
        if (selectionMode) {
          // Toggle highlight for selection
          if (!button.classList.contains('selected')) {
            button.classList.add('selected');
            selectedButtons.add(button);
          } else {
            button.classList.remove('selected');
            selectedButtons.delete(button);
          }
          updateModulatorEffects();
        } else {
          // Normal playback
          const freq = parseFloat(button.getAttribute('data-frequency'));
          playColumnSoundStart(column, freq);
        }
      }

      // === FIX #1: Only preventDefault on touch if NOT in selection mode
      button.addEventListener('touchstart', e => {
        if (!selectionMode) {
          e.preventDefault(); // prevents generating a "click" event on mobile
          const frequency = parseFloat(button.getAttribute('data-frequency'));
          const osc = audioCtx.createOscillator();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
          osc.connect(masterGain);
          osc.start();

          activeOscillators.set(button, osc);

          if (isRecording) {
            activeNotes.set(button, {
              column,
              frequency,
              startTime: performance.now(),
              duration: 0
            });
          }
        }
      }, { passive: false });

      // Stop oscillator on touchend
      button.addEventListener('touchend', e => {
        e.preventDefault();
        const osc = activeOscillators.get(button);
        if (osc) {
          osc.stop();
          osc.disconnect();
          activeOscillators.delete(button);
        }

        if (isRecording && activeNotes.has(button)) {
          const noteObj = activeNotes.get(button);
          noteObj.duration = performance.now() - noteObj.startTime;
          currentLayer.push(noteObj);
          activeNotes.delete(button);
        }
      }, { passive: false });

      // Stop on touchcancel
      button.addEventListener('touchcancel', e => {
        e.preventDefault();
        const osc = activeOscillators.get(button);
        if (osc) {
          osc.stop();
          osc.disconnect();
          activeOscillators.delete(button);
        }
        if (isRecording && activeNotes.has(button)) {
          const noteObj = activeNotes.get(button);
          noteObj.duration = performance.now() - noteObj.startTime;
          currentLayer.push(noteObj);
          activeNotes.delete(button);
        }
      }, { passive: false });

      // Normal click => handle selection or playback
      button.addEventListener('click', handleButtonSelection);
    });

    // === Record & Delete Buttons
    const recordButton = document.getElementById('recordButton');
    const deleteLoopButton = document.getElementById('deleteLoopButton');

    function handleRecordButtonClick() {
      if (!selectionMode) {
        // Normal record logic
        if (isRecording) {
          // Stop recording
          isRecording = false;
          activeNotes.forEach((noteObj) => {
            noteObj.duration = performance.now() - noteObj.startTime;
            currentLayer.push(noteObj);
          });
          activeNotes.clear();
          if (currentLayer.length) {
            recordedLayers.push(currentLayer);
          }
          currentLayer = [];
          recordButton.textContent = 'RECORD';
          if (recordedLayers.length > 0) {
            playRecordedLayers();
          }
        } else {
          // Start recording
          isRecording = true;
          playbackTimeouts.forEach(timeout => clearTimeout(timeout));
          playbackTimeouts = [];
          currentLayer = [];
          recordButton.textContent = 'STOP RECORDING';
        }
      } else {
        // Some small feedback if we are in selection mode
        recordButton.style.color = 'green';
        setTimeout(() => recordButton.style.color = '', 800);
      }
    }

    // === Long-Press Logic
    recordButton.addEventListener('mousedown', () => {
      holdTimeout = setTimeout(() => {
        if (!canUseSelectionMode) {
          alert("ERROR // The sequencer isn't available on your browser.");
          return;
        }
        // Toggle selection mode
        selectionMode = !selectionMode;
        recordButton.textContent = selectionMode ? 'RECORD AGAIN' : 'RECORD';

        if (!selectionMode) {
          // === FIX #2: leaving selection mode => ensure we are not recording
          isRecording = false; 
          recordButton.textContent = 'RECORD';

          // Clear selected
          selectedButtons.forEach(btn => btn.classList.remove('selected'));
          selectedButtons.clear();
          updateModulatorEffects();
        }
      }, 2000);
    });

    recordButton.addEventListener('touchstart', (e) => {
      e.preventDefault();
      holdTimeout = setTimeout(() => {
        if (!canUseSelectionMode) {
          alert("ERROR // The sequencer isn't available on your browser.");
          return;
        }
        selectionMode = !selectionMode;
        recordButton.textContent = selectionMode ? 'RECORD AGAIN' : 'RECORD';

        if (!selectionMode) {
          // same fix for mobile
          isRecording = false;
          recordButton.textContent = 'RECORD';
          selectedButtons.forEach(btn => btn.classList.remove('selected'));
          selectedButtons.clear();
          updateModulatorEffects();
        }
      }, 2000);
    }, { passive: false });

    recordButton.addEventListener('mouseup', () => {
      clearTimeout(holdTimeout);
      handleRecordButtonClick();
    });
    recordButton.addEventListener('mouseleave', () => {
      clearTimeout(holdTimeout);
    });
    recordButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      clearTimeout(holdTimeout);
      handleRecordButtonClick();
    }, { passive: false });
    recordButton.addEventListener('touchcancel', () => {
      clearTimeout(holdTimeout);
    });

    // DELETE LOOP
    deleteLoopButton.addEventListener('click', () => {
      playbackTimeouts.forEach(timeout => clearTimeout(timeout));
      playbackTimeouts = [];
      recordedLayers = [];
      currentLayer = [];
      isRecording = false;
      recordButton.textContent = 'RECORD';
    });

    // === Modulator Filter
    function updateModulatorEffects() {
      if (!selectionMode || selectedButtons.size === 0) {
        if (isFilterActive) {
          masterGain.disconnect();
          modulatorFilter.disconnect();
          masterGain.connect(audioCtx.destination);
          isFilterActive = false;
        }
        lfoOscillators.forEach(osc => {
          osc.stop();
          osc.disconnect();
        });
        lfoOscillators = [];
        return;
      }

      // connect filter if not
      if (!isFilterActive) {
        masterGain.disconnect();
        masterGain.connect(modulatorFilter).connect(audioCtx.destination);
        isFilterActive = true;
      }

      // stop old LFOs
      lfoOscillators.forEach(osc => {
        osc.stop();
        osc.disconnect();
      });
      lfoOscillators = [];

      let baseFreq = 500;
      let totalOffset = 0;

      selectedButtons.forEach(btn => {
        const freqVal = parseFloat(btn.getAttribute('data-frequency')) || 100;
        const lfo = audioCtx.createOscillator();
        const lfoGain = audioCtx.createGain();

        lfo.type = 'sine';
        lfo.frequency.value = freqVal / 50;
        lfoGain.gain.value = 200;

        lfo.connect(lfoGain);
        lfoGain.connect(modulatorFilter.frequency);

        lfo.start();
        lfoOscillators.push(lfo);
        totalOffset += freqVal;
      });

      const averageOffset = totalOffset / selectedButtons.size;
      modulatorFilter.frequency.value = baseFreq + averageOffset;
    }

    // === Username Pop-up
    const modalOverlay = document.getElementById("modalOverlay");
    const usernameInput = document.getElementById("usernameInput");
    const usernameSubmit = document.getElementById("usernameSubmit");

    window.addEventListener('load', () => {
      modalOverlay.style.display = 'flex';
    });

    usernameSubmit.addEventListener('click', () => {
      const userName = usernameInput.value.trim();
      if (!userName) return;
      localStorage.setItem('username', userName);
      if (userName === 'Agent33') {
        canUseSelectionMode = true;
      }
      modalOverlay.style.display = 'none';
    });

    // Prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchstart', (event) => {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    document.addEventListener('touchend', (event) => {
      const now = new Date().getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
  </script>
</body>
</html>
