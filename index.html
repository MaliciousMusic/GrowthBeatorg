<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sound Buttons (Web Audio API)</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
      background-color: #000000;
      overflow-y: scroll;
    }
    .main-flexbox {
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      background-color: #ffffff;
    }
    .row {
      display: flex;
      flex-direction: row;
      flex: 1;
    }
    .column {
      display: flex;
      flex-direction: column;
      flex: 1;
      background-color: #ffffff;
      box-sizing: border-box;
    }
    .button {
      flex: 1;
      border: 3px #f0f0f0;
      text-align: center;
      font-size: 1rem;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .button:hover {
      transform: scale(1.05);
    }
    .blue0 { background-color: #61abf6; }
    .blue { background-color: #0066cc; }
    .blue2 { background-color: #002d5b; }
    .yellow { background-color: #ffcc00; }
    .red { background-color: #b60808; }
    .orange { background-color: #ff6600; }
    .green0 { background-color: #98eb98; }
    .green1 { background-color: #79ff79; }
    .green2 { background-color: #52e252; }
    .green3 { background-color: #33cc33; }
    .green4 { background-color: #23a023; }
    .green5 { background-color: #146814; }
    .green6 { background-color: #075007; }
    .green7 { background-color: #003700; }
    .green8 { background-color: #002e00; }
    .green9 { background-color: #001a00; }
    .ye0 { background-color: #ffffcc; }
    .ye1 { background-color: #ffff99; }
    .ye2 { background-color: #ffcc66; }
    .ye3 { background-color: #ff9933; }
    .ye4 { background-color: #ff6600; }
    .ye5 { background-color: #cc5200; }
    .ye6 { background-color: #993d00; }
    .ye7 { background-color: #662900; }
    .ye8 { background-color: #4d1f00; }
    .ye9 { background-color: #331400; }
    .cyan { background-color: #00cccc; }
    .pink { background-color: #ff66cc; }
    .fuschia { background-color: #990b5e; }
    .purple { background-color: #4f045e; }
    .darkgray { background-color: #454545; }
    .gray { background-color: #808080; }
    .black { background-color: #171717; }
    .big-button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50px;
      width: 100%;
      gap: 10px;
    }
    .big-button {
      background-color: white;
      border: #0066cc;
      color: #000;
      font-family: "Arial";
      font-size: 1.2rem;
      width: 100%;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.3s;
    }
    .big-button:hover {
      background-color: #f0f0f0;
      transform: scale(1.05);
    }
    .selected {
      filter: brightness(250%);
    }
    footer {
      height: 10vh;
      background-color: #222;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      text-align: center;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <div class="main-flexbox">
    <div class="row">
      <div class="column" data-sound="hihat">
        <button id="sens_roue_1" class="button blue2" data-frequency="1000"></button>
        <button id="sens_roue_2" class="button blue" data-frequency="2000"></button>
      </div>
      <div class="column" data-sound="kick">
        <button id="start_number_dozen_00" class="button green0" data-frequency="20"></button>
        <button id="start_number_dozen_10" class="button green1" data-frequency="40"></button>
        <button id="start_number_dozen_20" class="button green2" data-frequency="60"></button>
        <button id="start_number_dozen_30" class="button green3" data-frequency="80"></button>
        <button id="start_number_unit_01" class="button green1" data-frequency="120"></button>
        <button id="start_number_unit_02" class="button green2" data-frequency="140"></button>
        <button id="start_number_unit_03" class="button green3" data-frequency="160"></button>
        <button id="start_number_unit_04" class="button green4" data-frequency="180"></button>
        <button id="start_number_unit_05" class="button green5" data-frequency="200"></button>
        <button id="start_number_unit_06" class="button green6" data-frequency="220"></button>
        <button id="start_number_unit_07" class="button green7" data-frequency="240"></button>
        <button id="start_number_unit_08" class="button green8" data-frequency="280.00"></button>
        <button id="start_number_unit_09" class="button green9" data-frequency="100"></button>
      </div>
      <div class="column" data-sound="distortion">
        <button id="ball_exit_nord" class="button red" data-frequency="100"></button>
        <button id="ball_exit_est" class="button orange" data-frequency="200"></button>
        <button id="ball_exit_sud" class="button yellow" data-frequency="100"></button>
        <button id="ball_exit_west" class="button green1" data-frequency="100"></button>
        <button id="ball_exit_nord_est" class="button cyan" data-frequency="300"></button>
        <button id="ball_exit_sud_est" class="button pink" data-frequency="500"></button>
        <button id="ball_exit_sud_ouest" class="button fuschia" data-frequency="600"></button>
        <button id="ball_exit_ouest" class="button purple" data-frequency="700"></button>
      </div>
      <div class="column" data-sound="bass">
        <button id="wheel_cc_nord" class="button red" data-frequency="100"></button>
        <button id="wheel_cc_est" class="button orange" data-frequency="200"></button>
        <button id="wheel_cc_sud" class="button yellow" data-frequency="100"></button>
        <!-- Fixed duplicate: renamed below from wheel_cc_est to wheel_cc_est2 -->
        <button id="wheel_cc_est2" class="button green1" data-frequency="100"></button>
        <button id="wheel_cc_nord_est" class="button cyan" data-frequency="300"></button>
        <button id="wheel_cc_sud_est" class="button pink" data-frequency="500"></button>
        <button id="wheel_cc_sud_ouest" class="button fuschia" data-frequency="600"></button>
        <button id="wheel_cc_exit_ouest" class="button purple" data-frequency="700"></button>
      </div>
      <div class="column" data-sound="snare">
        <button id="ball_speed1" class="button blue0" data-frequency="123.25"></button>
        <button id="ball_speed2" class="button blue" data-frequency="587.33"></button>
        <button id="ball_speed3" class="button blue2" data-frequency="659.25"></button>
      </div>
      <div class="column" data-sound="choir">
        <button id="end_number_dozen_00" class="button ye0" data-frequency="230"></button>
        <button id="end_number_dozen_10" class="button ye1" data-frequency="260"></button>
        <button id="end_number_dozen_20" class="button ye2" data-frequency="290"></button>
        <button id="end_number_dozen_30" class="button ye3" data-frequency="320"></button>
        <button id="end_number_unit_01" class="button ye1" data-frequency="380"></button>
        <button id="end_number_unit_02" class="button ye2" data-frequency="410"></button>
        <button id="end_number_unit_03" class="button ye3" data-frequency="440"></button>
        <button id="end_number_unit_04" class="button ye4" data-frequency="470"></button>
        <button id="end_number_unit_05" class="button ye5" data-frequency="500"></button>
        <button id="end_number_unit_06" class="button ye6" data-frequency="530"></button>
        <button id="end_number_unit_07" class="button ye7" data-frequency="560"></button>
        <button id="end_number_unit_08" class="button ye8" data-frequency="590"></button>
        <button id="end_number_unit_09" class="button ye9" data-frequency="350"></button>
      </div>
    </div>
    <div class="big-button-container">
      <button id="recordBtn" class="big-button">RECORD</button>
      <button id="deleteBtn" class="big-button" disabled>DELETE LOOP</button>
    </div>
    <footer class="footer">
      <p>Â© 2025 GrowthBeat. All Rights Reserved.</p>
    </footer>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "https://ixthgaoizmbuqlapgked.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4dGhnYW9pem1idXFsYXBna2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgwODIwNjcsImV4cCI6MjA1MzY1ODA2N30.uBvoKtSOYjL03sNr_lG9re3V2f20IOn-pg1WBgofFew";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    function collectSelectedData() {
      let sens_roue = false;
      let start_number_dozen = 0;
      let start_number_unit = 0;
      let start_number = 0;
      let ball_exit = "";
      let wheel_cc = "";
      let ball_speed = 0;
      let end_number_dozen = 0;
      let end_number_unit = 0;
      let end_number = 0;
      const sr1 = document.getElementById("sens_roue_1");
      const sr2 = document.getElementById("sens_roue_2");
      if (sr1 && sr1.classList.contains("selected")) {
        sens_roue = true;
      } else if (sr2 && sr2.classList.contains("selected")) {
        sens_roue = false;
      }
      if (document.getElementById("start_number_dozen_00").classList.contains("selected")) {
        start_number_dozen = 0;
      } else if (document.getElementById("start_number_dozen_10").classList.contains("selected")) {
        start_number_dozen = 10;
      } else if (document.getElementById("start_number_dozen_20").classList.contains("selected")) {
        start_number_dozen = 20;
      } else if (document.getElementById("start_number_dozen_30").classList.contains("selected")) {
        start_number_dozen = 30;
      }
      if (document.getElementById("start_number_unit_01").classList.contains("selected")) {
        start_number_unit = 1;
      } else if (document.getElementById("start_number_unit_02").classList.contains("selected")) {
        start_number_unit = 2;
      } else if (document.getElementById("start_number_unit_03").classList.contains("selected")) {
        start_number_unit = 3;
      } else if (document.getElementById("start_number_unit_04").classList.contains("selected")) {
        start_number_unit = 4;
      } else if (document.getElementById("start_number_unit_05").classList.contains("selected")) {
        start_number_unit = 5;
      } else if (document.getElementById("start_number_unit_06").classList.contains("selected")) {
        start_number_unit = 6;
      } else if (document.getElementById("start_number_unit_07").classList.contains("selected")) {
        start_number_unit = 7;
      } else if (document.getElementById("start_number_unit_08").classList.contains("selected")) {
        start_number_unit = 8;
      } else if (document.getElementById("start_number_unit_09").classList.contains("selected")) {
        start_number_unit = 9;
      }
      start_number = start_number_dozen + start_number_unit;
      if (document.getElementById("ball_exit_nord").classList.contains("selected")) {
        ball_exit = "nord";
      } else if (document.getElementById("ball_exit_est").classList.contains("selected")) {
        ball_exit = "est";
      } else if (document.getElementById("ball_exit_sud").classList.contains("selected")) {
        ball_exit = "sud";
      } else if (document.getElementById("ball_exit_west").classList.contains("selected")) {
        ball_exit = "ouest";
      } else if (document.getElementById("ball_exit_nord_est").classList.contains("selected")) {
        ball_exit = "nord_est";
      } else if (document.getElementById("ball_exit_sud_est").classList.contains("selected")) {
        ball_exit = "sud_est";
      } else if (document.getElementById("ball_exit_sud_ouest").classList.contains("selected")) {
        ball_exit = "sud_ouest";
      } else if (document.getElementById("ball_exit_ouest").classList.contains("selected")) {
        ball_exit = "ouest";
      }
      if (document.getElementById("wheel_cc_nord").classList.contains("selected")) {
        wheel_cc = "nord";
      } else if (document.getElementById("wheel_cc_est").classList.contains("selected")) {
        wheel_cc = "est";
      } else if (document.getElementById("wheel_cc_sud").classList.contains("selected")) {
        wheel_cc = "sud";
      } else if (document.getElementById("wheel_cc_est2").classList.contains("selected")) {
        wheel_cc = "est2";
      } else if (document.getElementById("wheel_cc_nord_est").classList.contains("selected")) {
        wheel_cc = "nord_est";
      } else if (document.getElementById("wheel_cc_sud_est").classList.contains("selected")) {
        wheel_cc = "sud_est";
      } else if (document.getElementById("wheel_cc_sud_ouest").classList.contains("selected")) {
        wheel_cc = "sud_ouest";
      } else if (document.getElementById("wheel_cc_exit_ouest").classList.contains("selected")) {
        wheel_cc = "ouest";
      }
      if (document.getElementById("ball_speed1").classList.contains("selected")) {
        ball_speed = 1;
      } else if (document.getElementById("ball_speed2").classList.contains("selected")) {
        ball_speed = 2;
      } else if (document.getElementById("ball_speed3").classList.contains("selected")) {
        ball_speed = 3;
      }
      if (document.getElementById("end_number_dozen_00").classList.contains("selected")) {
        end_number_dozen = 0;
      } else if (document.getElementById("end_number_dozen_10").classList.contains("selected")) {
        end_number_dozen = 10;
      } else if (document.getElementById("end_number_dozen_20").classList.contains("selected")) {
        end_number_dozen = 20;
      } else if (document.getElementById("end_number_dozen_30").classList.contains("selected")) {
        end_number_dozen = 30;
      }
      if (document.getElementById("end_number_unit_01").classList.contains("selected")) {
        end_number_unit = 1;
      } else if (document.getElementById("end_number_unit_02").classList.contains("selected")) {
        end_number_unit = 2;
      } else if (document.getElementById("end_number_unit_03").classList.contains("selected")) {
        end_number_unit = 3;
      } else if (document.getElementById("end_number_unit_04").classList.contains("selected")) {
        end_number_unit = 4;
      } else if (document.getElementById("end_number_unit_05").classList.contains("selected")) {
        end_number_unit = 5;
      } else if (document.getElementById("end_number_unit_06").classList.contains("selected")) {
        end_number_unit = 6;
      } else if (document.getElementById("end_number_unit_07").classList.contains("selected")) {
        end_number_unit = 7;
      } else if (document.getElementById("end_number_unit_08").classList.contains("selected")) {
        end_number_unit = 8;
      } else if (document.getElementById("end_number_unit_09").classList.contains("selected")) {
        end_number_unit = 9;
      }
      end_number = end_number_dozen + end_number_unit;
      return {
        sens_roue,
        start_number,
        ball_exit,
        wheel_cc,
        ball_speed,
        end_number
      };
    }
    document.getElementById("recordBtn").addEventListener("click", () => {
      const data = collectSelectedData();
      console.log("Collected Data:", data);
      supabaseClient
        .from("resultat")
        .insert([ data ])
        .then(response => {
          console.log("Inserted to Supabase:", response);
        })
        .catch(err => console.error(err));
    });
    let username = null;
    window.addEventListener('DOMContentLoaded', () => {
      username = prompt("Enter your username:");
    });
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isRecording = false;
    let recordedLayers = [];
    let currentLayer = [];
    let playbackTimeouts = [];
    let activeNotes = new Map();
    const activeOscillators = new Map();
    let selectionMode = false;
    let selectedButtons = new Set();
    let holdTimeout;
    function play808Sound(frequency) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
      gain.gain.setValueAtTime(1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(audioCtx.currentTime);
      osc.stop(audioCtx.currentTime + 1);
    }
    function playDistortionSpectralSpace(frequency) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const waveShaper = audioCtx.createWaveShaper();
      const filter = audioCtx.createBiquadFilter();
      osc.type = 'triangle';
      osc.frequency.value = frequency;
      waveShaper.curve = new Float32Array([1, 0.5, -0.5, 0]);
      waveShaper.oversample = '4x';
      filter.type = 'lowpass';
      filter.frequency.value = frequency * 2;
      filter.Q.value = 50;
      gain.gain.setValueAtTime(1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
      osc.connect(waveShaper).connect(filter).connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }
    function playChoir(frequency) {
      const osc = audioCtx.createOscillator();
      const formantFilter = audioCtx.createBiquadFilter();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = frequency;
      formantFilter.type = 'bandpass';
      formantFilter.frequency.value = 800;
      formantFilter.Q.value = 10;
      gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
      osc.connect(formantFilter).connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 2);
    }
    function playSynth1(frequency) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc1.type = 'sawtooth';
      osc1.frequency.value = frequency;
      osc2.type = 'sawtooth';
      osc2.frequency.value = frequency * 1.01;
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
      osc1.connect(gain).connect(audioCtx.destination);
      osc2.connect(gain);
      osc1.start();
      osc2.start();
      osc1.stop(audioCtx.currentTime + 2);
      osc2.stop(audioCtx.currentTime + 2);
    }
    function playSynth4(frequency) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc1.type = 'sine';
      osc1.frequency.value = frequency;
      osc2.type = 'sine';
      osc2.frequency.value = frequency * 1.5;
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
      osc1.connect(gain).connect(audioCtx.destination);
      osc2.connect(gain);
      osc1.start();
      osc2.start();
      osc1.stop(audioCtx.currentTime + 2);
      osc2.stop(audioCtx.currentTime + 2);
    }
    function playSynth6(frequency) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      osc1.type = 'triangle';
      osc1.frequency.value = frequency;
      osc2.type = 'triangle';
      osc2.frequency.value = frequency * 0.99;
      filter.type = 'bandpass';
      filter.frequency.value = frequency;
      filter.Q.value = 12;
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);
      osc1.connect(filter).connect(gain).connect(audioCtx.destination);
      osc2.connect(filter);
      osc1.start();
      osc2.start();
      osc1.stop(audioCtx.currentTime + 2);
      osc2.stop(audioCtx.currentTime + 2);
    }
    function playColumnSoundStart(column, frequency) {
      const soundType = column.getAttribute('data-sound');
      switch (soundType) {
        case 'kick':
          play808Sound(frequency);
          break;
        case 'distortion':
          playDistortionSpectralSpace(frequency);
          break;
        case 'choir':
          playChoir(frequency);
          break;
        case 'snare':
          playSynth1(frequency);
          break;
        case 'hihat':
          playSynth4(frequency);
          break;
        case 'bass':
          playSynth6(frequency);
          break;
        default:
          playChoir(frequency);
          break;
      }
    }
    function scheduleNotePlayback(column, frequency, offset, duration) {
      const soundType = column.getAttribute('data-sound');
      if (
        soundType === 'kick' ||
        soundType === 'distortion' ||
        soundType === 'choir' ||
        soundType === 'snare' ||
        soundType === 'hihat' ||
        soundType === 'bass'
      ) {
        const startTimeout = setTimeout(() => {
          playColumnSoundStart(column, frequency);
        }, offset);
        playbackTimeouts.push(startTimeout);
      } else {
        const startTimeout = setTimeout(() => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
          gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start();
          const stopTimeout = setTimeout(() => {
            osc.stop();
            osc.disconnect();
          }, duration);
          playbackTimeouts.push(stopTimeout);
        }, offset);
        playbackTimeouts.push(startTimeout);
      }
    }
    function playRecordedLayers() {
      playbackTimeouts.forEach(timeout => clearTimeout(timeout));
      playbackTimeouts = [];
      if (!recordedLayers.length) return;
      const maxDuration = Math.max(
        ...recordedLayers.flatMap(layer =>
          layer.map(entry => (entry.startTime + entry.duration) - layer[0].startTime)
        )
      );
      recordedLayers.forEach(layer => {
        const layerStart = layer[0].startTime;
        layer.forEach(entry => {
          const offset = entry.startTime - layerStart;
          scheduleNotePlayback(entry.column, entry.frequency, offset, entry.duration);
        });
      });
      const loopTimeout = setTimeout(playRecordedLayers, maxDuration + 500);
      playbackTimeouts.push(loopTimeout);
    }
    let lastTouchEnd = 0;
    document.addEventListener('touchstart',(event)=>{
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    },{ passive: false });
    document.addEventListener('touchend',(event)=>{
      const now = new Date().getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    },{ passive: false });
    const buttons = document.querySelectorAll('.button');
    function handleButtonSelection(e) {
      e.preventDefault();
      const button = e.currentTarget;
      const column = button.closest('.column');
      if (selectionMode) {
        const allColumns = Array.from(document.querySelectorAll('.column'));
        const columnIndex = allColumns.indexOf(column);
        if (columnIndex === 1 || columnIndex === 5) {
          const buttonsInThisColumn = column.querySelectorAll('.button');
          const alreadySelected = Array.from(buttonsInThisColumn).filter(b => b.classList.contains('selected'));
          if (button.classList.contains('selected')) {
            button.classList.remove('selected');
            selectedButtons.delete(button);
          } else {
            if (alreadySelected.length < 2) {
              button.classList.add('selected');
              selectedButtons.add(button);
            } else {
              for (const b of alreadySelected) {
                b.classList.remove('selected');
                selectedButtons.delete(b);
              }
              button.classList.add('selected');
              selectedButtons.add(button);
            }
          }
        } else {
          const buttonsInColumn = column.querySelectorAll('.button');
          buttonsInColumn.forEach(btn => {
            btn.classList.remove('selected');
            selectedButtons.delete(btn);
          });
          if (!button.classList.contains('selected')) {
            button.classList.add('selected');
            selectedButtons.add(button);
          }
        }
      } else {
        const frequency = parseFloat(button.getAttribute('data-frequency'));
        playColumnSoundStart(column, frequency);
      }
    }
    buttons.forEach(button => {
      const column = button.closest('.column');
      button.addEventListener('click', handleButtonSelection);
      button.addEventListener('touchstart', handleButtonSelection, { passive: false });
    });
    const recordButton = document.getElementById('recordBtn');
    const deleteButton = document.getElementById('deleteBtn');
    function handleRecordButtonLogic() {
      if (!selectionMode) {
        if (isRecording) {
          isRecording = false;
          activeNotes.forEach((noteObj, btn) => {
            noteObj.duration = performance.now() - noteObj.startTime;
            currentLayer.push(noteObj);
          });
          activeNotes.clear();
          if (currentLayer.length) {
            recordedLayers.push(currentLayer);
          }
          recordButton.textContent = 'RECORD';
          if (recordedLayers.length > 0) {
            playRecordedLayers();
          }
        } else {
          isRecording = true;
          currentLayer = [];
          recordButton.textContent = 'STOP RECORDING';
        }
      } else {
        const selectedData = Array.from(selectedButtons).map(button => ({
          frequency: button.getAttribute('data-frequency')
        }));
        console.log('Selected Data Sent:', selectedData);
        selectedButtons.forEach(btn => btn.classList.remove('selected'));
        selectedButtons.clear();
        recordButton.style.color = 'green';
        setTimeout(() => {
          recordButton.style.color = '';
        }, 1000);
      }
    }
    function toggleSelectionMode() {
      if (username === "Agent33") {
        selectionMode = !selectionMode;
        recordButton.textContent = selectionMode ? 'RECORD AGAIN' : 'RECORD';
        deleteButton.disabled = selectionMode;
        if (!selectionMode) {
          selectedButtons.forEach(btn => btn.classList.remove('selected'));
          selectedButtons.clear();
        }
      } else {
        alert("Error: Your browser doesn't support advanced mode.");
      }
    }
    recordButton.addEventListener('mousedown', () => {
      holdTimeout = setTimeout(() => {
        toggleSelectionMode();
      }, 2000);
    });
    recordButton.addEventListener('touchstart', (e) => {
      e.preventDefault();
      holdTimeout = setTimeout(() => {
        toggleSelectionMode();
      }, 2000);
    }, { passive: false });
    recordButton.addEventListener('mouseup', () => {
      clearTimeout(holdTimeout);
      handleRecordButtonLogic();
    });
    recordButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      clearTimeout(holdTimeout);
      handleRecordButtonLogic();
    }, { passive: false });
    recordButton.addEventListener('mouseleave', () => {
      clearTimeout(holdTimeout);
    });
    recordButton.addEventListener('touchcancel', () => {
      clearTimeout(holdTimeout);
    });
    function deleteCurrentLoop() {
      playbackTimeouts.forEach(timeout => clearTimeout(timeout));
      playbackTimeouts = [];
      recordedLayers = [];
      if (isRecording) {
        isRecording = false;
        activeNotes.clear();
        recordButton.textContent = 'RECORD';
      }
      currentLayer = [];
      console.log("All loops deleted.");
    }
    deleteButton.addEventListener('click', () => {
      if (!selectionMode) {
        deleteCurrentLoop();
      }
    });
    deleteButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      if (!selectionMode) {
        deleteCurrentLoop();
      }
    }, { passive: false });
  </script>
</body>
</html>
