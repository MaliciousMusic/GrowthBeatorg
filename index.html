<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sound Buttons (Web Audio API)</title>
  <style>
    /* --- General Styles --- */
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
      background-color: #000;
      overflow-y: scroll; /* allow scrolling if needed */
    }

    /* --- Main Container --- */
    .main-flexbox {
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      background-color: #fff;
    }

    /* --- Rows --- */
    .row {
      display: flex;
      flex-direction: row;
      flex: 1;
    }

    /* --- Columns --- */
    .column {
      display: flex;
      flex-direction: column;
      flex: 1;
      background-color: #fff;
      box-sizing: border-box;
      padding: 5px; /* spacing around the column so buttons have some breathing room */
    }

    /* --- Buttons (the “pads”) --- */
    .button {
      flex: 1;
      margin: 5px;                 /* spacing around each pad */
      border-radius: 10px;         /* rounded corners */
      color: #fff;                 /* text color */
      background-color: #444;      /* default pad background */
      box-shadow: 0 4px 0 #222;    /* simple “3D” effect */
      cursor: pointer;
      transition: 
        background-color 0.25s,
        box-shadow 0.25s,
        transform 0.2s;
      text-align: center;
      font-size: 1rem;
    }
    /* Slight “pop” on hover */
    .button:hover {
      transform: scale(1.04);
    }
    /* Pressed look */
    .button:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #111;
    }

    /* --- “Lit” state for wave effect --- */
    .lit {
      background-color: #ff9900;
      box-shadow: 0 0 15px #ff9900;
    }

    /* Example color variation (blue) if desired */
    .blue {
      background-color: #0066cc;
    }

    /* Big Button Container (Record, Delete, etc.) */
    .big-button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50px;
      width: 100%;
      gap: 10px; 
    }
    .big-button {
      background-color: white;
      border: #0066cc;
      color: #3021cd;
      font-family: "Arial";
      font-size: 1.2rem;
      width: 100%;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .big-button:hover {
      transform: scale(1.05);
    }

    /* Selected (for “Agent33” mode) */
    .selected {
      filter: brightness(65%);
    }

    footer {
      height: 10vh;
      background-color: #222;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="main-flexbox">

    <!-- First Row -->
    <div class="row">
      <!-- Column 1: "hihat" -->
      <div class="column" data-sound="hihat">
        <button id="sens_roue_1" class="button blue" data-frequency="1000">Uptempo</button>
        <button id="sens_roue_2" class="button blue" data-frequency="2000">Rewind</button>
      </div>

      <!-- Column 2: "kick" -->
      <div class="column" data-sound="kick">
        <button id="start_number_dozen_00" class="button blue" data-frequency="20">0</button>
        <button id="start_number_dozen_10" class="button blue" data-frequency="40">1</button>
        <button id="start_number_dozen_20" class="button blue" data-frequency="60">2</button>
        <button id="start_number_dozen_30" class="button blue" data-frequency="80">3</button>
        <button id="start_number_unit_01" class="button blue" data-frequency="120">1</button>
        <button id="start_number_unit_02" class="button blue" data-frequency="140">2</button>
        <button id="start_number_unit_03" class="button blue" data-frequency="160">3</button>
        <button id="start_number_unit_04" class="button blue" data-frequency="180">4</button>
        <button id="start_number_unit_05" class="button blue" data-frequency="200">5</button>
        <button id="start_number_unit_06" class="button blue" data-frequency="220">6</button>
        <button id="start_number_unit_07" class="button blue" data-frequency="240">7</button>
        <button id="start_number_unit_08" class="button blue" data-frequency="280.00">8</button>
        <button id="start_number_unit_09" class="button blue" data-frequency="100">9</button>
      </div>

      <!-- Column 3: "distortion" -->
      <div class="column" data-sound="distortion">
        <button id="ball_exit_nord" class="button blue" data-frequency="100">0</button>
        <button id="ball_exit_est" class="button blue" data-frequency="200">1</button>
        <button id="ball_exit_sud" class="button blue" data-frequency="100">2</button>
        <button id="ball_exit_ouest" class="button blue" data-frequency="100">3</button>
        <button id="ball_exit_nord_est" class="button blue" data-frequency="300">4</button>
        <button id="ball_exit_sud_est" class="button blue" data-frequency="500">5</button>
        <button id="ball_exit_sud_ouest" class="button blue" data-frequency="600">6</button>
        <button id="ball_exit_ouest_2" class="button blue" data-frequency="700">7</button>
      </div>

      <!-- Column 4: "bass" -->
      <div class="column" data-sound="bass">
        <button id="wheel_cc_0" class="button blue" data-frequency="100">0</button>
        <button id="wheel_cc_1" class="button blue" data-frequency="200">1</button>
        <button id="wheel_cc_2" class="button blue" data-frequency="300">2</button>
        <button id="wheel_cc_3" class="button blue" data-frequency="400">3</button>
        <button id="wheel_cc_4" class="button blue" data-frequency="500">4</button>
        <button id="wheel_cc_5" class="button blue" data-frequency="600">5</button>
        <button id="wheel_cc_6" class="button blue" data-frequency="700">6</button>
        <button id="wheel_cc_7" class="button blue" data-frequency="800">7</button>
        <button id="wheel_cc_8" class="button blue" data-frequency="900">8</button>
        <button id="wheel_cc_9" class="button blue" data-frequency="1000">9</button>
        <button id="wheel_cc_10" class="button blue" data-frequency="1100">10</button>
        <button id="wheel_cc_11" class="button blue" data-frequency="1200">11</button>
      </div>

      <!-- Column 5: "snare" -->
      <div class="column" data-sound="snare">
        <button id="ball_speed1" class="button blue" data-frequency="123.25">1</button>
        <button id="ball_speed2" class="button blue" data-frequency="587.33">2</button>
        <button id="ball_speed3" class="button blue" data-frequency="659.25">3</button>
      </div>

      <!-- Column 6: "choir" -->
      <div class="column" data-sound="choir">
        <button id="end_number_dozen_00" class="button blue" data-frequency="440.00">0</button>
        <button id="end_number_dozen_10" class="button blue" data-frequency="466.16">1</button>
        <button id="end_number_dozen_20" class="button blue" data-frequency="493.88">2</button>
        <button id="end_number_dozen_30" class="button blue" data-frequency="523.25">3</button>
        <button id="end_number_unit_01" class="button blue" data-frequency="554.37">1</button>
        <button id="end_number_unit_02" class="button blue" data-frequency="587.33">2</button>
        <button id="end_number_unit_03" class="button blue" data-frequency="622.25">3</button>
        <button id="end_number_unit_04" class="button blue" data-frequency="659.25">4</button>
        <button id="end_number_unit_05" class="button blue" data-frequency="698.46">5</button>
        <button id="end_number_unit_06" class="button blue" data-frequency="739.99">6</button>
        <button id="end_number_unit_07" class="button blue" data-frequency="783.99">7</button>
        <button id="end_number_unit_08" class="button blue" data-frequency="830.61">8</button>
        <button id="end_number_unit_09" class="button blue" data-frequency="880.00">9</button>
      </div>
    </div>

    <!-- RECORD / DELETE LOOP / METRONOME Buttons -->
    <div class="big-button-container">
      <button id="recordBtn" class="big-button">RECORD</button>
      <button id="deleteBtn" class="big-button" disabled>DELETE LOOP</button>
      <button id="metronomeBtn" class="big-button">METRONOME</button>
    </div>

    <footer class="footer">
      <p>© 2025 GrowthBeat. All Rights Reserved.</p>
    </footer>
  </div>


  <script>
    /****************************************
     *        SUPABASE Client Setup
     ****************************************/
    const SUPABASE_URL = "https://ixthgaoizmbuqlapgked.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE"; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /****************************************
     *        AUDIO CONTEXT
     ****************************************/
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    /****************************************
     *        GLOBAL STATE
     ****************************************/
    let username = null;
    let isRecording = false;
    let recordedLayers = [];
    let currentLayer = [];
    let playbackTimeouts = [];
    let activeNotes = new Map();       // track notes for "touchstart -> touchend" 
    const activeOscillators = new Map(); 

    let selectionMode = false;
    let selectedButtons = new Set(); 
    let holdTimeout;

    window.addEventListener('DOMContentLoaded', () => {
      username = prompt("Enter your username:");
    });

    /****************************************
     *       BUILD 2D “BUTTON MATRIX”
     ****************************************/
    const rows = Array.from(document.querySelectorAll('.row'));
    // Each row’s .button elements in an array
    const buttonMatrix = rows.map(rowElem => 
      Array.from(rowElem.querySelectorAll('.button'))
    );

    // Helper to find [row, col] position of a button in the matrix
    function findButtonPosition(btn) {
      for (let r = 0; r < buttonMatrix.length; r++) {
        const colIndex = buttonMatrix[r].indexOf(btn);
        if (colIndex !== -1) {
          return [r, colIndex];
        }
      }
      return null; // not found
    }

    // Orthogonal neighbors (up/down/left/right)
    function getNeighbors(r, c) {
      const neighbors = [];
      // up
      if (r - 1 >= 0 && buttonMatrix[r - 1][c]) {
        neighbors.push([r - 1, c]);
      }
      // down
      if (r + 1 < buttonMatrix.length && buttonMatrix[r + 1][c]) {
        neighbors.push([r + 1, c]);
      }
      // left
      if (c - 1 >= 0 && buttonMatrix[r][c - 1]) {
        neighbors.push([r, c - 1]);
      }
      // right
      if (c + 1 < buttonMatrix[r].length && buttonMatrix[r][c + 1]) {
        neighbors.push([r, c + 1]);
      }
      return neighbors;
    }

    /****************************************
     *   BFS WAVE LIGHT-UP ANIMATION
     ****************************************/
    function animateWave(startBtn) {
      const startPos = findButtonPosition(startBtn);
      if (!startPos) return;

      const visited = new Set();
      const queue = [{ pos: startPos, dist: 0 }];
      const maxDist = 5;           // how many steps outward
      const delayPerStep = 80;     // ms between wave expansions

      while (queue.length > 0) {
        const { pos, dist } = queue.shift();
        const key = pos.join(',');
        if (visited.has(key)) continue;
        visited.add(key);

        // schedule lighting up at dist * delay
        setTimeout(() => {
          const [rr, cc] = pos;
          buttonMatrix[rr][cc].classList.add('lit');
          setTimeout(() => {
            buttonMatrix[rr][cc].classList.remove('lit');
          }, 200);
        }, dist * delayPerStep);

        // only continue BFS if dist < maxDist
        if (dist < maxDist) {
          const nbrs = getNeighbors(rr, cc);
          nbrs.forEach(n => queue.push({ pos: n, dist: dist + 1 }));
        }
      }
    }

    /****************************************
     *       SOUND FUNCTIONS
     ****************************************/
    function play808Sound(frequency) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);

      gain.gain.setValueAtTime(1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 1);
    }

    function playDistortionSpectralSpace(frequency) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const waveShaper = audioCtx.createWaveShaper();
      const filter = audioCtx.createBiquadFilter();

      osc.type = 'triangle';
      osc.frequency.value = frequency;

      waveShaper.curve = new Float32Array([1, 0.5, -0.5, 0]);
      waveShaper.oversample = '4x';

      filter.type = 'lowpass';
      filter.frequency.value = frequency * 2;
      filter.Q.value = 50;

      gain.gain.setValueAtTime(1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);

      osc.connect(waveShaper).connect(filter).connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }

    function playChoir(frequency) {
      const gain = audioCtx.createGain();
      gain.gain.setValueAtTime(1.0, audioCtx.currentTime);
      gain.gain.setTargetAtTime(0.9, audioCtx.currentTime + 0.3, 0.1);
      gain.gain.setTargetAtTime(0.001, audioCtx.currentTime + 2, 0.7);

      function createOscillator(freq, detune = 0, vibratoDepth = 2) {
        const osc = audioCtx.createOscillator();
        osc.type = "sawtooth";
        osc.frequency.value = freq + detune;

        // Vibrato
        const vibrato = audioCtx.createOscillator();
        vibrato.type = "sine";
        vibrato.frequency.value = 3.5;
        const vibratoGain = audioCtx.createGain();
        vibratoGain.gain.value = vibratoDepth;
        vibrato.connect(vibratoGain).connect(osc.frequency);

        vibrato.start();
        osc.start();

        return { osc, vibrato };
      }

      const voices = [
        createOscillator(frequency, 0),
        createOscillator(frequency * 0.98, 0),
        createOscillator(frequency * 1.02, 0),
        createOscillator(frequency / 2, -5),
        createOscillator(frequency / 2.02, 5),
        createOscillator(frequency * 2, 10),
      ];

      function createFormantFilter(freq) {
        const filter = audioCtx.createBiquadFilter();
        filter.type = "bandpass";
        filter.frequency.value = freq;
        filter.Q.value = 8;
        return filter;
      }

      const formantFilters = [
        createFormantFilter(500),
        createFormantFilter(750),
        createFormantFilter(1100),
        createFormantFilter(2500),
      ];

      voices.forEach(({ osc }) => {
        formantFilters.forEach(f => {
          osc.connect(f).connect(gain);
        });
      });
      gain.connect(audioCtx.destination);

      setTimeout(() => {
        voices.forEach(({ osc, vibrato }) => {
          osc.stop();
          vibrato.stop();
        });
      }, 250);
    }

    function playSynth1(frequency) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc1.type = 'sawtooth';
      osc1.frequency.value = frequency;
      osc2.type = 'sawtooth';
      osc2.frequency.value = frequency * 1.01;

      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);

      osc1.connect(gain).connect(audioCtx.destination);
      osc2.connect(gain);

      osc1.start();
      osc2.start();
      osc1.stop(audioCtx.currentTime + 2);
      osc2.stop(audioCtx.currentTime + 2);
    }

    function playSynth4(frequency) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc1.type = 'sine';
      osc1.frequency.value = frequency;
      osc2.type = 'sine';
      osc2.frequency.value = frequency * 1.5;

      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);

      osc1.connect(gain).connect(audioCtx.destination);
      osc2.connect(gain);

      osc1.start();
      osc2.start();
      osc1.stop(audioCtx.currentTime + 2);
      osc2.stop(audioCtx.currentTime + 2);
    }

    function playSynth6(frequency) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();

      osc1.type = 'triangle';
      osc1.frequency.value = frequency;
      osc2.type = 'triangle';
      osc2.frequency.value = frequency * 0.99;

      filter.type = 'bandpass';
      filter.frequency.value = frequency;
      filter.Q.value = 12;

      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);

      osc1.connect(filter).connect(gain).connect(audioCtx.destination);
      osc2.connect(filter);

      osc1.start();
      osc2.start();
      osc1.stop(audioCtx.currentTime + 2);
      osc2.stop(audioCtx.currentTime + 2);
    }

    /****************************************
     *        PLAY SOUND BY COLUMN
     ****************************************/
    function playColumnSoundStart(column, frequency) {
      const soundType = column.getAttribute('data-sound');
      switch (soundType) {
        case 'kick':
          play808Sound(frequency);
          break;
        case 'distortion':
          playDistortionSpectralSpace(frequency);
          break;
        case 'choir':
          playChoir(frequency);
          break;
        case 'snare':
          playSynth1(frequency);
          break;
        case 'hihat':
          playSynth4(frequency);
          break;
        case 'bass':
          playSynth6(frequency);
          break;
        default:
          // fallback
          playChoir(frequency);
          break;
      }
    }

    /****************************************
     *    SCHEDULE + LOOP PLAYBACK
     ****************************************/
    function scheduleNotePlayback(column, frequency, offset, duration) {
      const startTimeout = setTimeout(() => {
        playColumnSoundStart(column, frequency);
      }, offset);
      playbackTimeouts.push(startTimeout);
    }

    function playRecordedLayers() {
      // Clear existing timeouts
      playbackTimeouts.forEach(timeout => clearTimeout(timeout));
      playbackTimeouts = [];

      if (!recordedLayers.length) return;

      // find the maximum duration among all layers
      const maxDuration = Math.max(
        ...recordedLayers.flatMap(layer =>
          layer.map(entry => (entry.startTime + entry.duration) - layer[0].startTime)
        )
      );

      recordedLayers.forEach(layer => {
        const layerStart = layer[0].startTime;
        layer.forEach(entry => {
          const offset = entry.startTime - layerStart;
          scheduleNotePlayback(entry.column, entry.frequency, offset, entry.duration);
        });
      });

      // loop forever
      const loopTimeout = setTimeout(playRecordedLayers, maxDuration + 500);
      playbackTimeouts.push(loopTimeout);
    }

    /****************************************
     *  EVENT LISTENERS FOR BUTTONS
     ****************************************/
    const allButtons = document.querySelectorAll('.button');
    allButtons.forEach(button => {
      const column = button.closest('.column');

      function handleButtonSelection() {
        if (selectionMode) {
          // “Agent33” selection logic (unchanged from your code)
          // (You can keep your existing column-based restrictions.)
          const allColumns = Array.from(document.querySelectorAll('.column'));
          const columnIndex = allColumns.indexOf(column);

          if (columnIndex === 1 || columnIndex === 5) {
            // limit 2 selections in these columns
            const buttonsInThisColumn = column.querySelectorAll('.button');
            const alreadySelected = Array.from(buttonsInThisColumn)
              .filter(b => b.classList.contains('selected'));

            if (button.classList.contains('selected')) {
              button.classList.remove('selected');
              selectedButtons.delete(button);
            } else {
              if (alreadySelected.length < 2) {
                button.classList.add('selected');
                selectedButtons.add(button);
              } else {
                // Already 2 => remove them, then select new
                for (const b of alreadySelected) {
                  b.classList.remove('selected');
                  selectedButtons.delete(b);
                }
                button.classList.add('selected');
                selectedButtons.add(button);
              }
            }
          } else {
            // Single selection in other columns
            const buttonsInColumn = column.querySelectorAll('.button');
            buttonsInColumn.forEach(btn => {
              btn.classList.remove('selected');
              selectedButtons.delete(btn);
            });
            if (!button.classList.contains('selected')) {
              button.classList.add('selected');
              selectedButtons.add(button);
            } else {
              button.classList.remove('selected');
              selectedButtons.delete(button);
            }
          }
        } else {
          // Normal mode => one-shot play + wave effect
          const frequency = parseFloat(button.getAttribute('data-frequency'));
          playColumnSoundStart(column, frequency);
          animateWave(button); // <-- triggers wave effect
        }
      }

      // For mouse or touch “click”:
      button.addEventListener('click', handleButtonSelection);

      // Touchstart => start oscillator (for your “hold note” effect)
      button.addEventListener('touchstart', e => {
        e.preventDefault();
        if (!selectionMode) {
          const frequency = parseFloat(button.getAttribute('data-frequency'));
          const osc = audioCtx.createOscillator();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
          osc.connect(audioCtx.destination);
          osc.start();

          activeOscillators.set(button, osc);

          if (isRecording) {
            activeNotes.set(button, {
              column,
              frequency,
              startTime: performance.now(),
              duration: 0
            });
          }
        }
        // Also do selection on touch:
        handleButtonSelection();
      }, { passive: false });

      // Touchend => stop oscillator
      button.addEventListener('touchend', e => {
        e.preventDefault();
        const osc = activeOscillators.get(button);
        if (osc) {
          osc.stop();
          osc.disconnect();
          activeOscillators.delete(button);
        }
        // record logic
        if (isRecording && activeNotes.has(button)) {
          const noteObj = activeNotes.get(button);
          noteObj.duration = performance.now() - noteObj.startTime;
          currentLayer.push(noteObj);
          activeNotes.delete(button);
        }
      }, { passive: false });

      // Touchcancel => similar cleanup
      button.addEventListener('touchcancel', e => {
        e.preventDefault();
        const osc = activeOscillators.get(button);
        if (osc) {
          osc.stop();
          osc.disconnect();
          activeOscillators.delete(button);
        }
        if (isRecording && activeNotes.has(button)) {
          const noteObj = activeNotes.get(button);
          noteObj.duration = performance.now() - noteObj.startTime;
          currentLayer.push(noteObj);
          activeNotes.delete(button);
        }
      }, { passive: false });
    });

    // Prevent double-tap zoom while allowing scroll
    let lastTouchEnd = 0;
    document.addEventListener('touchstart', event => {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    }, { passive: false });
    document.addEventListener('touchend', event => {
      const now = new Date().getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });

    /****************************************
     *    RECORD, DELETE, METRONOME
     ****************************************/
    const recordButton = document.getElementById('recordBtn');
    const deleteButton = document.getElementById('deleteBtn');
    const metronomeButton = document.getElementById('metronomeBtn');

    // 2) Fonctions pour collecter la sélection (mode “Agent33”)
    function collectSelectedData() {
      let sens_roue = false;  
      let start_number_dozen = 0; 
      let start_number_unit = 0;  
      let start_number = 0;       

      let ball_exit = "";   
      let wheel_cc = "";    
      let ball_speed = 0;   
      let end_number_dozen = 0;
      let end_number_unit = 0;
      let end_number = 0;

      // -------- sens_roue (boolean) --------
      if (document.getElementById("sens_roue_1").classList.contains("selected")) {
        sens_roue = true;
      } else if (document.getElementById("sens_roue_2").classList.contains("selected")) {
        sens_roue = false;
      }
      // -------- start_number_dozen --------
      if (document.getElementById("start_number_dozen_00").classList.contains("selected")) {
        start_number_dozen = 0;
      } else if (document.getElementById("start_number_dozen_10").classList.contains("selected")) {
        start_number_dozen = 10;
      } else if (document.getElementById("start_number_dozen_20").classList.contains("selected")) {
        start_number_dozen = 20;
      } else if (document.getElementById("start_number_dozen_30").classList.contains("selected")) {
        start_number_dozen = 30;
      }
      // -------- start_number_unit --------
      if (document.getElementById("start_number_unit_01").classList.contains("selected")) {
        start_number_unit = 1;
      } else if (document.getElementById("start_number_unit_02").classList.contains("selected")) {
        start_number_unit = 2;
      } else if (document.getElementById("start_number_unit_03").classList.contains("selected")) {
        start_number_unit = 3;
      } else if (document.getElementById("start_number_unit_04").classList.contains("selected")) {
        start_number_unit = 4;
      } else if (document.getElementById("start_number_unit_05").classList.contains("selected")) {
        start_number_unit = 5;
      } else if (document.getElementById("start_number_unit_06").classList.contains("selected")) {
        start_number_unit = 6;
      } else if (document.getElementById("start_number_unit_07").classList.contains("selected")) {
        start_number_unit = 7;
      } else if (document.getElementById("start_number_unit_08").classList.contains("selected")) {
        start_number_unit = 8;
      } else if (document.getElementById("start_number_unit_09").classList.contains("selected")) {
        start_number_unit = 9;
      }
      start_number = start_number_dozen + start_number_unit;

      // -------- ball_exit --------
      if (document.getElementById("ball_exit_nord").classList.contains("selected")) {
        ball_exit = "nord";
      } else if (document.getElementById("ball_exit_est").classList.contains("selected")) {
        ball_exit = "est";
      } else if (document.getElementById("ball_exit_sud").classList.contains("selected")) {
        ball_exit = "sud";
      } else if (document.getElementById("ball_exit_ouest").classList.contains("selected")) {
        ball_exit = "ouest";
      } else if (document.getElementById("ball_exit_nord_est").classList.contains("selected")) {
        ball_exit = "nord_est";
      } else if (document.getElementById("ball_exit_sud_est").classList.contains("selected")) {
        ball_exit = "sud_est";
      } else if (document.getElementById("ball_exit_sud_ouest").classList.contains("selected")) {
        ball_exit = "sud_ouest";
      } else if (document.getElementById("ball_exit_ouest_2").classList.contains("selected")) {
        ball_exit = "ouest";
      }

      // -------- wheel_cc --------
      if (document.getElementById("wheel_cc_0").classList.contains("selected")) {
        wheel_cc = "0";
      } else if (document.getElementById("wheel_cc_1").classList.contains("selected")) {
        wheel_cc = "1";
      } else if (document.getElementById("wheel_cc_2").classList.contains("selected")) {
        wheel_cc = "2";
      } else if (document.getElementById("wheel_cc_3").classList.contains("selected")) {
        wheel_cc = "3";
      } else if (document.getElementById("wheel_cc_4").classList.contains("selected")) {
        wheel_cc = "4";
      } else if (document.getElementById("wheel_cc_5").classList.contains("selected")) {
        wheel_cc = "5";
      } else if (document.getElementById("wheel_cc_6").classList.contains("selected")) {
        wheel_cc = "6";
      } else if (document.getElementById("wheel_cc_7").classList.contains("selected")) {
        wheel_cc = "7";
      } else if (document.getElementById("wheel_cc_8").classList.contains("selected")) {
        wheel_cc = "8";
      } else if (document.getElementById("wheel_cc_9").classList.contains("selected")) {
        wheel_cc = "9";
      } else if (document.getElementById("wheel_cc_10").classList.contains("selected")) {
        wheel_cc = "10";
      } else if (document.getElementById("wheel_cc_11").classList.contains("selected")) {
        wheel_cc = "11";
      }

      // -------- ball_speed --------
      if (document.getElementById("ball_speed1").classList.contains("selected")) {
        ball_speed = 1;
      } else if (document.getElementById("ball_speed2").classList.contains("selected")) {
        ball_speed = 2;
      } else if (document.getElementById("ball_speed3").classList.contains("selected")) {
        ball_speed = 3;
      }

      // -------- end_number_dozen --------
      if (document.getElementById("end_number_dozen_00").classList.contains("selected")) {
        end_number_dozen = 0;
      } else if (document.getElementById("end_number_dozen_10").classList.contains("selected")) {
        end_number_dozen = 10;
      } else if (document.getElementById("end_number_dozen_20").classList.contains("selected")) {
        end_number_dozen = 20;
      } else if (document.getElementById("end_number_dozen_30").classList.contains("selected")) {
        end_number_dozen = 30;
      }

      // -------- end_number_unit --------
      if (document.getElementById("end_number_unit_01").classList.contains("selected")) {
        end_number_unit = 1;
      } else if (document.getElementById("end_number_unit_02").classList.contains("selected")) {
        end_number_unit = 2;
      } else if (document.getElementById("end_number_unit_03").classList.contains("selected")) {
        end_number_unit = 3;
      } else if (document.getElementById("end_number_unit_04").classList.contains("selected")) {
        end_number_unit = 4;
      } else if (document.getElementById("end_number_unit_05").classList.contains("selected")) {
        end_number_unit = 5;
      } else if (document.getElementById("end_number_unit_06").classList.contains("selected")) {
        end_number_unit = 6;
      } else if (document.getElementById("end_number_unit_07").classList.contains("selected")) {
        end_number_unit = 7;
      } else if (document.getElementById("end_number_unit_08").classList.contains("selected")) {
        end_number_unit = 8;
      } else if (document.getElementById("end_number_unit_09").classList.contains("selected")) {
        end_number_unit = 9;
      }
      end_number = end_number_dozen + end_number_unit;

      return {
        sens_roue,
        start_number,
        ball_exit,
        wheel_cc,
        ball_speed,
        end_number
      };
    }

    function handleRecordButtonLogic() {
      if (!selectionMode) {
        // Normal record mode
        if (isRecording) {
          // Stop recording
          isRecording = false;
          activeNotes.forEach((noteObj, btn) => {
            noteObj.duration = performance.now() - noteObj.startTime;
            currentLayer.push(noteObj);
          });
          activeNotes.clear();

          if (currentLayer.length) {
            recordedLayers.push(currentLayer);
          }
          recordButton.textContent = 'RECORD';

          // Start loop playback if we have recorded layers
          if (recordedLayers.length > 0) {
            playRecordedLayers();
            deleteButton.disabled = false;
          }
        } else {
          // Start recording
          isRecording = true;
          currentLayer = [];
          recordButton.textContent = 'STOP RECORDING';
        }
      } else {
        // Selection mode => send to Supabase
        const data = collectSelectedData();
        console.log('Collected Data:', data);

        supabaseClient
          .from("resultat")
          .insert([ data ])
          .then(response => {
            console.log("Inserted to Supabase:", response);
            recordButton.style.color = 'green';
            setTimeout(() => {
              recordButton.style.color = '';
            }, 1000);
          })
          .catch(error => {
            console.error("Erreur insertion Supabase:", error);
          });

        // Deselect everything
        selectedButtons.forEach(btn => btn.classList.remove('selected'));
        selectedButtons.clear();
      }
    }

    // Toggle selection mode if username is “Agent33”
    function toggleSelectionMode() {
      if (username === "Agent33") {
        selectionMode = !selectionMode;
        recordButton.textContent = selectionMode
          ? 'RECORD AGAIN'
          : 'RECORD';

        deleteButton.disabled = selectionMode;
        if (!selectionMode) {
          // reset selection
          selectedButtons.forEach(btn => btn.classList.remove('selected'));
          selectedButtons.clear();
        }
      } else {
        alert("Error: Your browser doesn't support advanced mode.");
      }
    }

    // Long press on RECORD => toggles selection mode
    recordButton.addEventListener('mousedown', () => {
      holdTimeout = setTimeout(() => {
        toggleSelectionMode();
      }, 2000);
    });
    recordButton.addEventListener('touchstart', (e) => {
      e.preventDefault();
      holdTimeout = setTimeout(() => {
        toggleSelectionMode();
      }, 2000);
    }, { passive: false });

    recordButton.addEventListener('mouseup', () => {
      clearTimeout(holdTimeout);
      handleRecordButtonLogic();
    });
    recordButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      clearTimeout(holdTimeout);
      handleRecordButtonLogic();
    }, { passive: false });

    recordButton.addEventListener('mouseleave', () => {
      clearTimeout(holdTimeout);
    });
    recordButton.addEventListener('touchcancel', () => {
      clearTimeout(holdTimeout);
    });

    // DELETE LOOP
    function deleteCurrentLoop() {
      playbackTimeouts.forEach(timeout => clearTimeout(timeout));
      playbackTimeouts = [];
      recordedLayers = [];
      if (isRecording) {
        isRecording = false;
        activeNotes.clear();
        recordButton.textContent = 'RECORD';
      }
      currentLayer = [];
      console.log("All loops deleted.");
      deleteButton.disabled = true;
    }
    deleteButton.addEventListener('click', () => {
      if (!selectionMode) {
        deleteCurrentLoop();
      }
    });
    deleteButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      if (!selectionMode) {
        deleteCurrentLoop();
      }
    }, { passive: false });

    // METRONOME
    let metronomeInterval = null;
    let isMetronomeOn = false;

    function playMetronomeClick() {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();

      osc.type = "sine";
      osc.frequency.value = 800;

      filter.type = "lowpass";
      filter.frequency.value = 1200;
      filter.Q.value = 1;

      gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);

      osc.connect(filter).connect(gain).connect(audioCtx.destination);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.1);
    }

    metronomeButton.addEventListener("click", () => {
      if (isMetronomeOn) {
        clearInterval(metronomeInterval);
        metronomeInterval = null;
        isMetronomeOn = false;
        metronomeButton.textContent = "METRONOME";
      } else {
        playMetronomeClick();
        metronomeInterval = setInterval(playMetronomeClick, 1000);
        isMetronomeOn = true;
        metronomeButton.textContent = "STOP METRONOME";
      }
    });
  </script>
</body>
</html>
